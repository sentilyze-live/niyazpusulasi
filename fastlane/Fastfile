default_platform(:ios)

platform :ios do

  # ─────────────────────────────────────────────
  # Shared configuration
  # ─────────────────────────────────────────────

  APP_IDENTIFIER    = "com.niyazpusulasi.app"
  WIDGET_IDENTIFIER = "com.niyazpusulasi.app.widget"
  SCHEME            = "NiyazPusulasi"
  PROJECT           = "NiyazPusulasi.xcodeproj"
  TEAM_ID           = "C4WUTK99E3"
  KEYCHAIN_NAME     = "build.keychain"
  KEYCHAIN_PASSWORD = "temporary_ci_password"

  before_all do
    if ENV['CI']
      # Create a dedicated keychain for this build
      create_keychain(
        name: KEYCHAIN_NAME,
        password: KEYCHAIN_PASSWORD,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end
  end

  after_all do |lane|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
  end

  error do |lane, exception|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
    UI.error("Lane #{lane} failed: #{exception.message}")
  end

  # ─────────────────────────────────────────────
  # Lane: tests
  # ─────────────────────────────────────────────
  desc "Run all unit tests"
  lane :tests do
    run_tests(
      project: PROJECT,
      scheme: SCHEME,
      device: "iPhone 15 Pro",
      clean: true,
      code_coverage: true
    )
  end

  # ─────────────────────────────────────────────
  # Lane: beta
  # Builds and uploads to TestFlight
  # ─────────────────────────────────────────────
  desc "Build and upload to TestFlight"
  lane :beta do
    # Increment build number
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id:      ENV["ASC_KEY_ID"],
      issuer_id:   ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:    1200,
      in_house:    false
    )

    # Install certificates + provisioning profiles into our keychain
    # readonly: true — never regenerate certs in CI; run setup-certificates workflow first
    match(
      type:             "appstore",
      app_identifier:   [APP_IDENTIFIER, WIDGET_IDENTIFIER],
      readonly:         true,
      api_key:          api_key,
      keychain_name:    KEYCHAIN_NAME,
      keychain_password: KEYCHAIN_PASSWORD
    )

    # Build
    build_app(
      project:          PROJECT,
      scheme:           SCHEME,
      export_method:    "app-store",
      output_directory: "./build",
      output_name:      "NiyazPusulasi.ipa",
      clean:            true,
      export_options: {
        method: "app-store",
        teamID: TEAM_ID,
        signingStyle: "manual",
        provisioningProfiles: lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key:                          api_key,
      skip_waiting_for_build_processing: true,
      changelog:                        "CI build - #{last_git_commit[:message]}"
    )
  end

  # ─────────────────────────────────────────────
  # Lane: upload_metadata
  # Uploads only metadata (no binary) to App Store
  # Languages: tr, en-US, ar-SA
  # ─────────────────────────────────────────────
  desc "Upload metadata (description, keywords, title) to App Store — no binary upload"
  lane :upload_metadata do
    api_key = app_store_connect_api_key(
      key_id:       ENV["ASC_KEY_ID"],
      issuer_id:    ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:     1200,
      in_house:     false
    )

    deliver(
      api_key:             api_key,
      skip_binary_upload:  true,
      skip_screenshots:    true,
      skip_app_version_update: false,
      force:               true,
      languages:           ["tr", "en-US", "ar-SA"],
      precheck_include_in_app_purchases: false
    )
  end

  # ─────────────────────────────────────────────
  # Lane: release
  # ─────────────────────────────────────────────
  desc "Submit to App Store review"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id:      ENV["ASC_KEY_ID"],
      issuer_id:   ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:    1200,
      in_house:    false
    )

    deliver(
      api_key:                      api_key,
      submit_for_review:            true,
      automatic_release:            false,
      force:                        true,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  # ─────────────────────────────────────────────
  # Lane: setup_iap
  # Creates subscription group + monthly/yearly products in App Store Connect.
  # Run once before first submission: bundle exec fastlane setup_iap
  # ─────────────────────────────────────────────
  desc "Create subscription group and products in App Store Connect"
  lane :setup_iap do
    require 'spaceship'

    api_key = app_store_connect_api_key(
      key_id:       ENV["ASC_KEY_ID"],
      issuer_id:    ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:     1200,
      in_house:     false
    )

    Spaceship::ConnectAPI.auth(api_key: api_key)

    app = Spaceship::ConnectAPI::App.find(APP_IDENTIFIER)
    UI.user_error!("App #{APP_IDENTIFIER} not found") unless app

    # --- Subscription Group ---
    groups = Spaceship::ConnectAPI::SubscriptionGroup.all(app_id: app.id)
    group = groups.find { |g| g.reference_name == "Premium Plans" }

    unless group
      group = Spaceship::ConnectAPI::SubscriptionGroup.create(
        app_id: app.id,
        reference_name: "Premium Plans"
      )
      UI.success("Created subscription group: Premium Plans (id: #{group.id})")
    else
      UI.message("Subscription group already exists: #{group.id}")
    end

    # --- Helper: create or skip ---
    def create_sub(group, product_id, name, duration, trial_days)
      existing = Spaceship::ConnectAPI::Subscription.all(group_id: group.id)
                   .find { |s| s.product_id == product_id }
      if existing
        UI.message("#{product_id} already exists, skipping.")
        return
      end

      sub = Spaceship::ConnectAPI::Subscription.create(
        group_id:         group.id,
        product_id:       product_id,
        name:             name,
        family_shareable: true,
        subscription_period: duration,
        review_note:      "Subscription unlocks all premium features of Niyaz Pusulası."
      )

      # Add free trial introductory offer
      Spaceship::ConnectAPI::SubscriptionIntroductoryOffer.create(
        subscription_id:   sub.id,
        duration:          "P#{trial_days}D",
        offer_mode:        "FREE_TRIAL",
        number_of_periods: 1
      ) if trial_days > 0

      # Localization (Turkish)
      Spaceship::ConnectAPI::SubscriptionLocalization.create(
        subscription_id: sub.id,
        locale:          "tr",
        name:            name,
        description:     "Niyaz Pusulası'nın tüm premium özelliklerine erişim."
      )

      UI.success("Created #{product_id}")
    end

    create_sub(group, "niyaz_premium_monthly", "Niyaz Premium - Aylık",  "P1M", 7)
    create_sub(group, "niyaz_premium_yearly",  "Niyaz Premium - Yıllık", "P1Y", 7)

    UI.success("IAP setup complete! Group ID: #{group.id}")
    UI.important("Next: Go to App Store Connect → Subscriptions → set pricing for both products.")
  end

  # ─────────────────────────────────────────────
  # Lane: screenshots
  # Captures App Store screenshots via UI tests.
  # Config is in fastlane/Snapfile.
  # Triggered via GitHub Actions: .github/workflows/screenshots.yml
  # ─────────────────────────────────────────────
  desc "Capture App Store screenshots"
  lane :screenshots do
    capture_screenshots(
      scheme: SCHEME,
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true
    )
  end

end
