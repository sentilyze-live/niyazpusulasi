default_platform(:ios)

platform :ios do

  # ─────────────────────────────────────────────
  # Shared configuration
  # ─────────────────────────────────────────────

  APP_IDENTIFIER = "com.niyazpusulasi.app"
  WIDGET_IDENTIFIER = "com.niyazpusulasi.app.widget"
  SCHEME = "NiyazPusulasi"
  PROJECT = "NiyazPusulasi.xcodeproj"

  before_all do
    setup_ci if ENV['CI']
  end

  # ─────────────────────────────────────────────
  # Lane: tests
  # Runs unit tests on simulator
  # ─────────────────────────────────────────────
  desc "Run all unit tests"
  lane :tests do
    run_tests(
      project: PROJECT,
      scheme: SCHEME,
      device: "iPhone 15 Pro",
      clean: true,
      code_coverage: true
    )
  end

  # ─────────────────────────────────────────────
  # Lane: beta
  # Builds and uploads to TestFlight
  # ─────────────────────────────────────────────
  desc "Build and upload to TestFlight"
  lane :beta do
    # Increment build number (uses timestamp for uniqueness)
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # Setup App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration: 1200,
      in_house: false
    )

    # Code signing via Match
    match(
      type: "appstore",
      app_identifier: [APP_IDENTIFIER, WIDGET_IDENTIFIER],
      readonly: true
    )

    # Build the app
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      export_method: "app-store",
      output_directory: "./build",
      output_name: "NiyazPusulasi.ipa",
      clean: true,
      include_bitcode: false,
      xcargs: "CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=C4WUTK99E3"
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      changelog: "Otomatik CI/CD build - #{last_git_commit[:message]}"
    )
  end

  # ─────────────────────────────────────────────
  # Lane: release
  # Submits to App Store for review
  # ─────────────────────────────────────────────
  desc "Submit to App Store review"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration: 1200,
      in_house: false
    )

    # Upload metadata and submit for review
    deliver(
      api_key: api_key,
      submit_for_review: true,
      automatic_release: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  # ─────────────────────────────────────────────
  # Lane: screenshots
  # Captures App Store screenshots
  # ─────────────────────────────────────────────
  desc "Capture App Store screenshots"
  lane :screenshots do
    capture_screenshots(
      scheme: SCHEME,
      devices: [
        "iPhone 15 Pro Max",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["tr-TR", "en-US"],
      clear_previous_screenshots: true
    )
  end

  # ─────────────────────────────────────────────
  # Error handling
  # ─────────────────────────────────────────────
  error do |lane, exception|
    UI.error("Lane #{lane} failed: #{exception.message}")
  end
end
