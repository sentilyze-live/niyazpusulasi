default_platform(:ios)

platform :ios do

  # ─────────────────────────────────────────────
  # Shared configuration
  # ─────────────────────────────────────────────

  APP_IDENTIFIER    = "com.niyazpusulasi.app"
  WIDGET_IDENTIFIER = "com.niyazpusulasi.app.widget"
  SCHEME            = "NiyazPusulasi"
  PROJECT           = "NiyazPusulasi.xcodeproj"
  TEAM_ID           = "C4WUTK99E3"
  KEYCHAIN_NAME     = "build.keychain"
  KEYCHAIN_PASSWORD = "temporary_ci_password"

  before_all do
    if ENV['CI']
      create_keychain(
        name:             KEYCHAIN_NAME,
        password:         KEYCHAIN_PASSWORD,
        default_keychain: true,
        unlock:           true,
        timeout:          3600,
        lock_when_sleeps: false
      )
    end
  end

  after_all do |lane|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
  end

  error do |lane, exception|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
    UI.error("Lane '#{lane}' failed: #{exception.message}")
  end

  # ─────────────────────────────────────────────
  # Lane: build_release
  # Fetches AppStore certs via match and builds IPA.
  # asc-client handles upload/submission — not fastlane.
  # ─────────────────────────────────────────────
  desc "Fetch AppStore certificates and build signed IPA"
  lane :build_release do
    api_key = app_store_connect_api_key(
      key_id:       ENV["ASC_KEY_ID"],
      issuer_id:    ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:     1200,
      in_house:     false
    )

    match(
      type:              "appstore",
      app_identifier:    [APP_IDENTIFIER, WIDGET_IDENTIFIER],
      readonly:          true,
      api_key:           api_key,
      keychain_name:     KEYCHAIN_NAME,
      keychain_password: KEYCHAIN_PASSWORD
    )

    build_app(
      project:          PROJECT,
      scheme:           SCHEME,
      export_method:    "app-store",
      output_directory: "./build",
      output_name:      "NiyazPusulasi.ipa",
      clean:            true,
      export_options: {
        method:               "app-store",
        teamID:               TEAM_ID,
        signingStyle:         "manual",
        provisioningProfiles: lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
      }
    )
  end

  # ─────────────────────────────────────────────
  # Lane: tests
  # ─────────────────────────────────────────────
  desc "Run unit tests on simulator"
  lane :tests do
    run_tests(
      project:       PROJECT,
      scheme:        SCHEME,
      device:        "iPhone 16 Pro",
      clean:         true,
      code_coverage: true
    )
  end

  # ─────────────────────────────────────────────
  # Lane: setup_iap
  # Creates subscription group + products in ASC.
  # Run once: bundle exec fastlane setup_iap
  # ─────────────────────────────────────────────
  desc "Create IAP subscription group and products in App Store Connect (run once)"
  lane :setup_iap do
    require 'spaceship'

    api_key = app_store_connect_api_key(
      key_id:       ENV["ASC_KEY_ID"],
      issuer_id:    ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:     1200,
      in_house:     false
    )

    Spaceship::ConnectAPI.auth(api_key: api_key)

    app = Spaceship::ConnectAPI::App.find(APP_IDENTIFIER)
    UI.user_error!("App #{APP_IDENTIFIER} not found") unless app

    groups = Spaceship::ConnectAPI::SubscriptionGroup.all(app_id: app.id)
    group  = groups.find { |g| g.reference_name == "Premium Plans" }

    unless group
      group = Spaceship::ConnectAPI::SubscriptionGroup.create(
        app_id:         app.id,
        reference_name: "Premium Plans"
      )
      UI.success("Created subscription group: Premium Plans (id: #{group.id})")
    else
      UI.message("Subscription group already exists: #{group.id}")
    end

    def create_sub(group, product_id, name, duration, trial_days)
      existing = Spaceship::ConnectAPI::Subscription.all(group_id: group.id)
                   .find { |s| s.product_id == product_id }
      if existing
        UI.message("#{product_id} already exists, skipping.")
        return
      end

      sub = Spaceship::ConnectAPI::Subscription.create(
        group_id:            group.id,
        product_id:          product_id,
        name:                name,
        family_shareable:    true,
        subscription_period: duration,
        review_note:         "Subscription unlocks all premium features of Niyaz Pusulasi."
      )

      if trial_days > 0
        Spaceship::ConnectAPI::SubscriptionIntroductoryOffer.create(
          subscription_id:   sub.id,
          duration:          "P#{trial_days}D",
          offer_mode:        "FREE_TRIAL",
          number_of_periods: 1
        )
      end

      Spaceship::ConnectAPI::SubscriptionLocalization.create(
        subscription_id: sub.id,
        locale:          "tr",
        name:            name,
        description:     "Niyaz Pusulasi'nin tum premium ozelliklerine erisim."
      )

      UI.success("Created #{product_id}")
    end

    create_sub(group, "niyaz_premium_monthly", "Niyaz Premium - Aylik",  "P1M", 7)
    create_sub(group, "niyaz_premium_yearly",  "Niyaz Premium - Yillik", "P1Y", 7)

    UI.success("IAP setup complete! Group ID: #{group.id}")
    UI.important("Next: App Store Connect -> Subscriptions -> set pricing for both products.")
  end

end
