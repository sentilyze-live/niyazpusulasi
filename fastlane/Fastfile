default_platform(:ios)

platform :ios do

  # ─────────────────────────────────────────────
  # Shared configuration
  # ─────────────────────────────────────────────

  APP_IDENTIFIER    = "com.niyazpusulasi.app"
  WIDGET_IDENTIFIER = "com.niyazpusulasi.app.widget"
  SCHEME            = "NiyazPusulasi"
  PROJECT           = "NiyazPusulasi.xcodeproj"
  TEAM_ID           = "C4WUTK99E3"
  KEYCHAIN_NAME     = "build.keychain"
  KEYCHAIN_PASSWORD = "temporary_ci_password"

  before_all do
    if ENV['CI']
      # Create a dedicated keychain for this build
      create_keychain(
        name: KEYCHAIN_NAME,
        password: KEYCHAIN_PASSWORD,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end
  end

  after_all do |lane|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
  end

  error do |lane, exception|
    if ENV['CI']
      delete_keychain(name: KEYCHAIN_NAME) rescue nil
    end
    UI.error("Lane #{lane} failed: #{exception.message}")
  end

  # ─────────────────────────────────────────────
  # Lane: tests
  # ─────────────────────────────────────────────
  desc "Run all unit tests"
  lane :tests do
    run_tests(
      project: PROJECT,
      scheme: SCHEME,
      device: "iPhone 15 Pro",
      clean: true,
      code_coverage: true
    )
  end

  # ─────────────────────────────────────────────
  # Lane: beta
  # Builds and uploads to TestFlight
  # ─────────────────────────────────────────────
  desc "Build and upload to TestFlight"
  lane :beta do
    # Increment build number
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    # App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id:      ENV["ASC_KEY_ID"],
      issuer_id:   ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:    1200,
      in_house:    false
    )

    # Install certificates + provisioning profiles into our keychain
    match(
      type:             "appstore",
      app_identifier:   [APP_IDENTIFIER, WIDGET_IDENTIFIER],
      readonly:         false,
      api_key:          api_key,
      keychain_name:    KEYCHAIN_NAME,
      keychain_password: KEYCHAIN_PASSWORD
    )

    # Build
    build_app(
      project:          PROJECT,
      scheme:           SCHEME,
      export_method:    "app-store",
      output_directory: "./build",
      output_name:      "NiyazPusulasi.ipa",
      clean:            true,
      export_options: {
        method: "app-store",
        teamID: TEAM_ID,
        signingStyle: "manual",
        provisioningProfiles: {
          APP_IDENTIFIER    => "match AppStore #{APP_IDENTIFIER}",
          WIDGET_IDENTIFIER => "match AppStore #{WIDGET_IDENTIFIER}"
        }
      }
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key:                          api_key,
      skip_waiting_for_build_processing: true,
      changelog:                        "CI build - #{last_git_commit[:message]}"
    )
  end

  # ─────────────────────────────────────────────
  # Lane: release
  # ─────────────────────────────────────────────
  desc "Submit to App Store review"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id:      ENV["ASC_KEY_ID"],
      issuer_id:   ENV["ASC_ISSUER_ID"],
      key_filepath: "AuthKey.p8",
      duration:    1200,
      in_house:    false
    )

    deliver(
      api_key:                      api_key,
      submit_for_review:            true,
      automatic_release:            false,
      force:                        true,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  # ─────────────────────────────────────────────
  # Lane: screenshots
  # ─────────────────────────────────────────────
  desc "Capture App Store screenshots"
  lane :screenshots do
    capture_screenshots(
      scheme: SCHEME,
      devices: [
        "iPhone 15 Pro Max",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["tr-TR", "en-US"],
      clear_previous_screenshots: true
    )
  end

end
