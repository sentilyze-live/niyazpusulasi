name: Upload App Store Metadata

on:
  workflow_dispatch:

jobs:
  upload_metadata:
    name: Upload Metadata (tr-TR, en-US, ar-SA)
    runs-on: macos-15
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Decode API Key
        env:
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
        run: |
          set -euo pipefail
          if echo "$ASC_KEY_CONTENT" | grep -q "BEGIN.*PRIVATE KEY"; then
            printf '%s' "$ASC_KEY_CONTENT" > AuthKey.p8
          else
            echo "$ASC_KEY_CONTENT" | base64 --decode > AuthKey.p8 2>/dev/null || \
            echo "$ASC_KEY_CONTENT" | base64 -d > AuthKey.p8 2>/dev/null || \
            echo "$ASC_KEY_CONTENT" | base64 -D > AuthKey.p8
          fi
          grep -q "BEGIN.*PRIVATE KEY" AuthKey.p8 || (echo "ERROR: AuthKey.p8 is not a valid private key" && exit 1)

      - name: Upload Metadata to App Store
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
        run: bundle exec fastlane upload_metadata

      - name: Clean up
        if: always()
        run: rm -f AuthKey.p8
